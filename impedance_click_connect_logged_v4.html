<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Impedance Builder ‚Äî v4 (dblclick –ø–æ –ø–∏–Ω—É —É–¥–∞–ª—è–µ—Ç –ø—Ä–æ–≤–æ–¥–∞, –∞–≤—Ç–æ—Ä–∞—Å—á—ë—Ç)</title>
<style>
:root{
  --bg:#0f1115;--panel:#151923;--card:#1a2030;--ink:#e8edf5;--muted:#93a0b4;
  --accent:#5eead4;--danger:#f87171;--pplus:#ffb4b4;--pminus:#b4d0ff;
  --wire:#a3bffa;--wireSel:#60a5fa;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:#0f1115;color:var(--ink);font:14px/1.45 system-ui,Segoe UI,Inter,Roboto,Arial}
/* Header */
header{height:56px;background:#141a26;border-bottom:1px solid #1f2637;display:flex;align-items:center;gap:10px;padding:8px 12px;position:fixed;inset:0 0 auto 0;z-index:5}
.brand{font-weight:800} .muted{color:var(--muted)}
button{background:var(--card);border:1px solid #2a3246;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
button:hover{background:#21283a}
/* Layout */
#wrap{position:fixed;inset:56px 0 0 0;display:grid;grid-template-columns:300px 1fr}
aside{background:var(--panel);border-right:1px solid #1f2637;padding:12px;overflow:auto}
h3{margin:8px 0 10px;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.14em}
.card{background:var(--card);border:1px solid #28324a;border-radius:12px;padding:10px;margin:0 0 8px}
.row{display:flex;align-items:center;justify-content:space-between;gap:8px}
.badge{font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid #2b3650;background:#0d1324;color:var(--muted)}
.list{display:grid;gap:8px}
/* Stage */
#stage{
  position:relative;
  background:
    linear-gradient(#121826 1px,transparent 1px) 0 0/100% 24px,
    linear-gradient(90deg,#121826 1px,transparent 1px) 0 0/24px 100%,
    #0b0f18;
}
svg#wires{position:absolute;inset:0;pointer-events:auto;z-index:0;width:100%;height:100%}
.node{position:absolute;min-width:220px;background:var(--card);border:1px solid #2a3246;border-radius:14px;padding:10px;box-shadow:0 10px 28px rgba(0,0,0,.28);user-select:none;z-index:1}
.node .title{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.node .title input{flex:1;min-width:0;background:transparent;border:0;border-bottom:1px dashed #334;outline:none;color:var(--ink);font-weight:700}
.node .body{display:grid;gap:8px}
input[type=number]{width:100%;background:#0e1320;color:var(--ink);border:1px solid #2a3246;border-radius:8px;padding:6px 8px}
/* Ports */
.ports{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:8px;margin-top:6px}
.sideL,.sideR{display:flex;align-items:center;gap:6px}
.sideL{justify-content:flex-start}
.sideR{justify-content:flex-end}
.port{width:18px;height:18px;border-radius:50%;border:2px solid #242b3e;background:#192036;position:relative;cursor:pointer;outline:2px solid transparent}
.port.plus{background:#32191a;border-color:#5a2a2e}
.port.minus{background:#172236;border-color:#2b3e5a}
.port.plus::after{content:"+";position:absolute;inset:0;color:var(--pplus);font-weight:900;font-size:12px;display:grid;place-items:center}
.port.minus::after{content:"‚àí";position:absolute;inset:0;color:var(--pminus);font-weight:900;font-size:12px;display:grid;place-items:center}
.port.sel{outline-color:var(--accent)}
.kv{font-size:12px;color:var(--muted)}
/* Wires */
.wire{stroke:var(--wire);stroke-width:3;opacity:.95;fill:none;filter:drop-shadow(0 0 6px rgba(96,165,250,.35));pointer-events:stroke}
.wire.sel{stroke:var(--wireSel);stroke-width:5}
.wire.hit{stroke-width:10;stroke-opacity:0;pointer-events:stroke}
/* Log window */
#logWrap{position:fixed;right:10px;bottom:10px;width:360px;max-height:40vh;background:#0b1222;border:1px solid #223049;border-radius:10px;display:flex;flex-direction:column;z-index:10}
#logHead{display:flex;align-items:center;justify-content:space-between;padding:6px 8px;border-bottom:1px solid #223049;color:#cbd5e1;font-weight:700}
#logBody{padding:6px 8px;overflow:auto;font-family:ui-monospace,Consolas,monaco,monospace;font-size:12px;color:#cbd5e1}
.log-info{color:#a7f3d0}
.log-warn{color:#fde68a}
.log-error{color:#fca5a5}
#result{font-weight:900;color:var(--accent)}
</style>
</head>
<body>
<header>
  <div class="brand">Impedance Builder</div>
  <button id="btnAmp">‚ûï –£—Å–∏–ª–∏—Ç–µ–ª—å</button>
  <button id="btnSpk">‚ûï –î–∏–Ω–∞–º–∏–∫</button>
  <button id="btnCalc">‚ö° –†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
  <button id="btnClear">‚ôªÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
  <div style="margin-left:auto" class="muted">–ò—Ç–æ–≥–æ–≤–æ–µ Z: <span id="result">‚Äî</span></div>
</header>

<div id="wrap">
  <aside>
    <h3>–ö–∞–∫ —Å–æ–µ–¥–∏–Ω—è—Ç—å</h3>
    <div class="card">
      <div class="row"><div class="muted">–ö–ª–∏–∫ –ø–æ –ø–∏–Ω—É ‚Üí –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—Å—è. –í—Ç–æ—Ä–æ–π –∫–ª–∏–∫ –ø–æ –¥—Ä—É–≥–æ–º—É –ø–∏–Ω—É ‚Äî —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–æ–≤–æ–¥.</div></div>
      <div class="row"><div class="muted">–£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–≤–æ–¥–∞: <b>–¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –ø–æ –ø–∏–Ω—É</b> ‚Äî —Å–Ω–∏–º–∞–µ—Ç –≤—Å–µ –ø—Ä–æ–≤–æ–¥–∞ —Å —ç—Ç–æ–≥–æ –ø–∏–Ω–∞; <b>–¥–≤–æ–π–Ω–æ–π/–ø—Ä–∞–≤—ã–π –∫–ª–∏–∫ –ø–æ –ª–∏–Ω–∏–∏</b> ‚Äî —É–¥–∞–ª—è–µ—Ç —ç—Ç—É –ª–∏–Ω–∏—é.</div></div>
      <div class="row"><div class="muted"><b>+</b> –≤—Å–µ–≥–¥–∞ —Å–ª–µ–≤–∞, <b>‚àí</b> –≤—Å–µ–≥–¥–∞ —Å–ø—Ä–∞–≤–∞.</div></div>
    </div>
    <h3>–≠–ª–µ–º–µ–Ω—Ç—ã</h3>
    <div id="list" class="list"></div>
    <h3>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</h3>
    <div class="card muted">–ê–≤—Ç–æ—Ä–∞—Å—á—ë—Ç –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ–µ Z –º–µ–∂–¥—É –∫–ª–µ–º–º–∞–º–∏ —É—Å–∏–ª–∏—Ç–µ–ª—è –¥–ª—è <u>–ø–æ–¥–∫–ª—é—á—ë–Ω–Ω–æ–π —á–∞—Å—Ç–∏</u> —Ü–µ–ø–∏. –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∏–Ω–∞–º–∏–∫–∏ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è.</div>
  </aside>

  <div id="stage">
    <svg id="wires"></svg>
  </div>
</div>

<!-- Log -->
<div id="logWrap">
  <div id="logHead">
    <span>–õ–æ–≥</span>
    <div>
      <button id="logClear">–û—á–∏—Å—Ç–∏—Ç—å</button>
      <button id="logToggle">–°–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
  <div id="logBody"></div>
</div>

<script>
/* ==================== –õ–û–ì–ì–ï–† ==================== */
const logBody=document.getElementById('logBody');
document.getElementById('logClear').onclick=()=>{logBody.innerHTML='';};
document.getElementById('logToggle').onclick=()=>{logBody.style.display=(logBody.style.display==='none'?'block':'none');};
function log(line, cls='log-info'){const p=document.createElement('div');p.className=cls;p.textContent='['+new Date().toLocaleTimeString()+'] '+line;logBody.appendChild(p);logBody.scrollTop=logBody.scrollHeight;}
const logInfo=m=>log(m,'log-info'), logWarn=m=>log(m,'log-warn'), logError=m=>log(m,'log-error');

/* ==================== –ú–û–î–ï–õ–¨/–•–ï–õ–ü–ï–†–´ ==================== */
const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
let uid=1; const nextId=p=>`${p}${uid++}`;
const stage=$("#stage"), svg=$("#wires"), list=$("#list"), result=$("#result");
const st={ amp:null, spk:[], wires:[], src:{pos:null,neg:null} };

/* ==================== –°–û–ó–î–ê–ù–ò–ï/–†–ï–ù–î–ï–† ==================== */
function addAmp(x=110,y=160){
  if(st.amp){ logWarn('–£—Å–∏–ª–∏—Ç–µ–ª—å —É–∂–µ –µ—Å—Ç—å'); return; }
  const id=nextId('amp_'), plus=nextId('p_'), minus=nextId('p_');
  const amp={id,x,y,name:'Amplifier',plus,minus};
  st.amp=amp; renderAmp(amp); refreshList(); setSource(plus,minus); logInfo('–î–æ–±–∞–≤–ª–µ–Ω —É—Å–∏–ª–∏—Ç–µ–ª—å '+id); recalc();
}
function addSpk(x=520,y=180){
  const id=nextId('spk_'), plus=nextId('p_'), minus=nextId('p_');
  const sp={id,x,y,name:`Speaker ${st.spk.length+1}`,R:8,plus,minus};
  st.spk.push(sp); renderSpk(sp); refreshList(); logInfo('–î–æ–±–∞–≤–ª–µ–Ω –¥–∏–Ω–∞–º–∏–∫ '+id); recalc();
}
function renderAmp(a){
  const n=document.createElement('div'); n.className='node'; n.dataset.kind='amp'; n.dataset.id=a.id;
  n.style.left=a.x+'px'; n.style.top=a.y+'px';
  n.innerHTML=`
    <div class="title"><input value="${a.name}"/><span class="badge">—É—Å–∏–ª–∏—Ç–µ–ª—å</span>
      <button class="del">üóë</button></div>
    <div class="body">
      <div class="ports">
        <div class="sideL"><div class="port plus" data-port="${a.plus}"></div></div>
        <div class="kv">CH-1</div>
        <div class="sideR"><div class="port minus" data-port="${a.minus}"></div></div>
      </div>
    </div>`;
  stage.appendChild(n); makeDrag(n);
  n.querySelector('.del').onclick=()=>{ removeNode(a.id); st.amp=null; st.src.pos=null; st.src.neg=null; result.textContent='‚Äî'; logWarn('–£—Å–∏–ª–∏—Ç–µ–ª—å —É–¥–∞–ª—ë–Ω'); recalc(); };
  n.querySelector('.title input').oninput=e=>{ a.name=e.target.value; refreshList(); };
}
function renderSpk(s){
  const n=document.createElement('div'); n.className='node'; n.dataset.kind='spk'; n.dataset.id=s.id;
  n.style.left=s.x+'px'; n.style.top=s.y+'px';
  n.innerHTML=`
    <div class="title"><input value="${s.name}"/><span class="badge">–¥–∏–Ω–∞–º–∏–∫</span>
      <button class="del">üóë</button></div>
    <div class="body">
      <div class="kv">–°–æ–ø—Ä., Œ© <input class="rval" type="number" step="0.1" min="0" value="${s.R}"></div>
      <div class="ports">
        <div class="sideL"><div class="port plus" data-port="${s.plus}"></div></div>
        <div class="kv">R</div>
        <div class="sideR"><div class="port minus" data-port="${s.minus}"></div></div>
      </div>
    </div>`;
  stage.appendChild(n); makeDrag(n);
  n.querySelector('.del').onclick=()=>{ removeNode(s.id); recalc(); };
  n.querySelector('.rval').oninput=e=>{ s.R=Math.max(0,parseFloat(e.target.value||0)); recalc(); };
  n.querySelector('.title input').oninput=e=>{ s.name=e.target.value; refreshList(); };
}

/* ==================== –°–û–ï–î–ò–ù–ï–ù–ò–ï/–£–î–ê–õ–ï–ù–ò–ï ==================== */
let selPort=null;
stage.addEventListener('click',(e)=>{
  const t=e.target.closest('.port'); if(!t) return;
  const pid=t.dataset.port; if(!pid){ logWarn('–ü–∏–Ω –±–µ–∑ data-port'); return; }
  if(!selPort){ selPort=pid; $$('.port').forEach(p=>p.classList.remove('sel')); t.classList.add('sel'); logInfo('–í—ã–±—Ä–∞–Ω –ø–∏–Ω '+pid); }
  else if(selPort===pid){ t.classList.remove('sel'); selPort=null; logInfo('–°–Ω—è—Ç–∞ –≤—ã–¥–µ–ª–µ–Ω–Ω–∞—è –∫–ª–µ–º–º–∞'); }
  else{ const a=selPort,b=pid; st.wires.push({a,b,id:nextId('w_')}); selPort=null; $$('.port').forEach(p=>p.classList.remove('sel')); redraw(); logInfo(`–°–æ–∑–¥–∞–Ω –ø—Ä–æ–≤–æ–¥ ${a} ‚Üî ${b}`); recalc(); }
});
/* –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –ø–æ –ü–ò–ù–£: —Å–Ω–∏–º–∞–µ—Ç –≤—Å–µ –ø—Ä–æ–≤–æ–¥–∞, –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–µ –∫ —ç—Ç–æ–º—É –ø–∏–Ω—É */
stage.addEventListener('dblclick',(e)=>{
  const t=e.target.closest('.port'); if(!t) return;
  const pid=t.dataset.port; const before=st.wires.length;
  st.wires = st.wires.filter(w=>!(w.a===pid||w.b===pid));
  const removed = before - st.wires.length;
  if(removed>0){ logWarn(`–° –ø–∏–Ω–∞ ${pid} —Å–Ω—è—Ç–æ –ø—Ä–æ–≤–æ–¥–æ–≤: ${removed}`); redraw(); recalc(); }
});
/* –£–¥–∞–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–π –ª–∏–Ω–∏–∏: –¥–≤–æ–π–Ω–æ–π/–ø—Ä–∞–≤—ã–π –∫–ª–∏–∫ –ø–æ —Å–∞–º–æ–π –ª–∏–Ω–∏–∏ */
svg.addEventListener('dblclick',(e)=>{ if(e.target.tagName.toLowerCase()!=='path') return; removeWire(e.target.dataset.id); });
svg.addEventListener('contextmenu',(e)=>{ if(e.target.tagName.toLowerCase()!=='path') return; e.preventDefault(); removeWire(e.target.dataset.id); });

/* –†–∏—Å–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–æ–¥–æ–≤ */
let selectedWireId=null;
function drawWire(w){
  const A=centerOfPort(w.a), B=centerOfPort(w.b);
  const path=document.createElementNS('http://www.w3.org/2000/svg','path');
  path.setAttribute('d',cubic(A,B)); path.setAttribute('class','wire'); path.dataset.id=w.id;
  const hit=document.createElementNS('http://www.w3.org/2000/svg','path');
  hit.setAttribute('d',cubic(A,B)); hit.setAttribute('class','wire hit'); hit.dataset.id=w.id;
  [path,hit].forEach(el=>{
    el.addEventListener('click',()=>{ selectedWireId=w.id; $$('#wires .wire').forEach(p=>p.classList.remove('sel')); path.classList.add('sel'); });
  });
  svg.appendChild(hit); svg.appendChild(path);
}
function removeWire(id){ st.wires=st.wires.filter(x=>x.id!==id); redraw(); logWarn('–£–¥–∞–ª—ë–Ω –ø—Ä–æ–≤–æ–¥ '+id); recalc(); }
function redraw(){
  svg.setAttribute('width', stage.clientWidth);
  svg.setAttribute('height', stage.clientHeight);
  svg.innerHTML='';
  for(const w of st.wires){ drawWire(w); }
}
window.addEventListener('keydown',(e)=>{ if((e.key==='Delete'||e.key==='Backspace') && selectedWireId){ removeWire(selectedWireId); selectedWireId=null; } });
window.addEventListener('resize',()=>{ redraw(); });

/* ==================== –ì–ï–û–ú–ï–¢–†–ò–Ø ==================== */
function centerOfPort(pid){
  const p=stage.querySelector(`.port[data-port="${pid}"]`); if(!p){ logWarn('centerOfPort: –Ω–µ –Ω–∞–π–¥–µ–Ω '+pid); return {x:0,y:0}; }
  const r=p.getBoundingClientRect(), rs=stage.getBoundingClientRect();
  return {x:r.left-rs.left+r.width/2, y:r.top-rs.top+r.height/2};
}
function cubic(A,B){ return `M ${A.x} ${A.y} C ${A.x+40} ${A.y} ${B.x-40} ${B.y} ${B.x} ${B.y}`; }

/* ==================== –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–ï –£–ó–õ–û–í ==================== */
function makeDrag(node){
  let ox=0,oy=0,drag=false;
  node.addEventListener('mousedown',e=>{
    if(e.target.closest('input,button,.port')) return;
    drag=true; const r=node.getBoundingClientRect(); ox=e.clientX-r.left; oy=e.clientY-r.top; node.style.transition='none';
  });
  document.addEventListener('mousemove',e=>{
    if(!drag) return; const rs=stage.getBoundingClientRect();
    let x=e.clientX-rs.left-ox, y=e.clientY-rs.top-oy;
    x=Math.max(8,Math.min(rs.width-180,x)); y=Math.max(8,Math.min(rs.height-90,y));
    node.style.left=x+'px'; node.style.top=y+'px';
    const id=node.dataset.id, k=node.dataset.kind;
    if(k==='amp'){ st.amp.x=x; st.amp.y=y; }
    if(k==='spk'){ const o=st.spk.find(v=>v.id===id); o.x=x;o.y=y; }
    redraw();
  });
  document.addEventListener('mouseup',()=>{ drag=false; node.style.transition=''; });
}

/* ==================== –ü–ê–ù–ï–õ–¨/–£–î–ê–õ–ï–ù–ò–ï –£–ó–õ–û–í ==================== */
function removeNode(id){
  if(st.amp && st.amp.id===id){
    const ports=[st.amp.plus,st.amp.minus];
    st.wires=st.wires.filter(w=>!ports.includes(w.a)&&!ports.includes(w.b));
    $$('.node').forEach(n=>{ if(n.dataset.id===id) n.remove(); });
    st.amp=null;
  }else if(st.spk.some(x=>x.id===id)){
    const sp=st.spk.find(x=>x.id===id);
    st.wires=st.wires.filter(w=>![sp.plus,sp.minus].includes(w.a)&&![sp.plus,sp.minus].includes(w.b));
    st.spk=st.spk.filter(x=>x.id!==id);
    $$('.node').forEach(n=>{ if(n.dataset.id===id) n.remove(); });
  }
  refreshList(); redraw();
}
function refreshList(){
  list.innerHTML='';
  if(st.amp){
    const a=st.amp, c=document.createElement('div'); c.className='card';
    c.innerHTML=`<div class="row"><b>${a.name}</b><button class="rm">–£–¥–∞–ª–∏—Ç—å</button></div>
                 <div class="muted">–ò—Å—Ç–æ—á–Ω–∏–∫: + —Å–ª–µ–≤–∞, ‚àí —Å–ø—Ä–∞–≤–∞</div>`;
    c.querySelector('.rm').onclick=()=>{ removeNode(a.id); recalc(); };
    list.appendChild(c);
  }
  for(const s of st.spk){
    const c=document.createElement('div'); c.className='card';
    c.innerHTML=`<div class="row"><b>${s.name}</b><button class="rm">–£–¥–∞–ª–∏—Ç—å</button></div>
                 <div class="muted">R = ${s.R.toFixed(2)} Œ©</div>`;
    c.querySelector('.rm').onclick=()=>{ removeNode(s.id); recalc(); };
    list.appendChild(c);
  }
}

/* ==================== –°–ï–¢–ò/–ò–°–¢–û–ß–ù–ò–ö/–†–ê–°–ß–Å–¢ ==================== */
function netsMap(){
  const ports=[];
  if(st.amp){ ports.push(st.amp.plus,st.amp.minus); }
  st.spk.forEach(s=>ports.push(s.plus,s.minus));
  const parent={}; ports.forEach(p=>parent[p]=p);
  const find=a=>parent[a]===a?a:(parent[a]=find(parent[a]));
  const uni=(a,b)=>{a=find(a);b=find(b); if(a!==b) parent[b]=a;};
  st.wires.forEach(w=>uni(w.a,w.b));
  const map={}, out={}; let k=1;
  for(const p of ports){ const r=find(p); if(!map[r]) map[r]=`NET_${k++}`; out[p]=map[r]; }
  return out;
}
function setSource(plusPort, minusPort){
  const m=netsMap(); st.src.pos=m[plusPort]; st.src.neg=m[minusPort]; logInfo(`–ò—Å—Ç–æ—á–Ω–∏–∫: ${st.src.pos} ( + ) / ${st.src.neg} ( ‚àí )`);
}
/* –£–∑–ª–æ–≤–æ–π –∞–Ω–∞–ª–∏–∑: —Å—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—É—é —á–∞—Å—Ç—å. –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ —É—Ä–∞–≤–Ω–µ–Ω–∏—è. */
function calcZ(){
  const m=netsMap(); const nets=Array.from(new Set(Object.values(m)));
  if(!st.amp){ result.textContent='‚Äî'; return; }
  if(!st.src.pos||!st.src.neg){ setSource(st.amp.plus,st.amp.minus); }
  if(st.src.pos===st.src.neg){ result.textContent='0 Œ©'; logWarn('–ö–æ—Ä–æ—Ç–∫–æ–µ –º–µ–∂–¥—É –∫–ª–µ–º–º–∞–º–∏'); return; }
  const Rs=[]; for(const s of st.spk){ const a=m[s.plus], b=m[s.minus]; if(a&&b) Rs.push({a,b,R:Math.max(1e-7,s.R)}); }
  if(Rs.length===0){ result.textContent='‚àû Œ©'; return; }
  const adj={}; for(const r of Rs){ (adj[r.a]??=[]).push(r.b); (adj[r.b]??=[]).push(r.a); }
  const seen=new Set([st.src.pos]); const q=[st.src.pos];
  while(q.length){ const u=q.shift(); for(const v of (adj[u]||[])) if(!seen.has(v)){ seen.add(v); q.push(v);} }
  if(!seen.has(st.src.neg)){ result.textContent='‚àû Œ©'; return; } // –Ω–µ—Ç –∑–∞–º–∫–Ω—É—Ç–æ–≥–æ –ø—É—Ç–∏ –º–µ–∂–¥—É + –∏ ‚àí
  const unknown = nets.filter(n=>n!==st.src.pos && n!==st.src.neg && seen.has(n)); // —Ç–æ–ª—å–∫–æ –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–µ —É–∑–ª—ã
  const idx=new Map(); unknown.forEach((n,i)=>idx.set(n,i));
  const n=unknown.length, G=Array.from({length:n},()=>Array(n).fill(0)), b=Array(n).fill(0);
  function addCond(a,bn,g){
    const ia=idx.get(a), ib=idx.get(bn);
    // –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ä—ë–±—Ä–∞ –≤–Ω—É—Ç—Ä–∏ –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
    if(!seen.has(a) && a!==st.src.pos && a!==st.src.neg) return;
    if(!seen.has(bn) && bn!==st.src.pos && bn!==st.src.neg) return;
    if(ia!==undefined){ G[ia][ia]+=g; if(ib!==undefined) G[ia][ib]-=g; else b[ia]+=g*((bn===st.src.pos)?1:0); }
    if(ib!==undefined){ G[ib][ib]+=g; if(ia!==undefined) G[ib][ia]-=g; else b[ib]+=g*((a===st.src.pos)?1:0); }
  }
  Rs.forEach(r=>addCond(r.a,r.b,1/Math.max(1e-12,r.R)));
  const V=solve(G,b); if(V===null){ result.textContent='‚Äî'; return; }
  let I=0;
  for(const r of Rs){
    if(!(seen.has(r.a)||r.a===st.src.pos||r.a===st.src.neg)) continue;
    if(!(seen.has(r.b)||r.b===st.src.pos||r.b===st.src.neg)) continue;
    const Va = r.a===st.src.pos ? 1 : r.a===st.src.neg ? 0 : V[idx.get(r.a)];
    const Vb = r.b===st.src.pos ? 1 : r.b===st.src.neg ? 0 : V[idx.get(r.b)];
    if(r.a===st.src.pos) I += (1 - Vb)/r.R;
    if(r.b===st.src.pos) I += (1 - Va)/r.R;
  }
  if(!isFinite(I)||Math.abs(I)<1e-12){ result.textContent='‚àû Œ©'; }
  else { const R=1/I; result.textContent = `${R.toFixed(3)} Œ©`; logInfo(`Z=${R.toFixed(6)} Œ©`); }
}
function solve(A,b){
  const n=A.length; if(!n) return [];
  A=A.map(r=>r.slice()); b=b.slice();
  for(let i=0;i<n;i++){
    let piv=i; for(let r=i+1;r<n;r++) if(Math.abs(A[r][i])>Math.abs(A[piv][i])) piv=r;
    if(Math.abs(A[piv][i])<1e-12) return null;
    if(piv!==i){ [A[i],A[piv]]=[A[piv],A[i]]; [b[i],b[piv]]=[b[piv],b[i]]; }
    const d=A[i][i]; for(let c=i;c<n;c++) A[i][c]/=d; b[i]/=d;
    for(let r=0;r<n;r++){ if(r===i)continue; const f=A[r][i]; if(Math.abs(f)<1e-12)continue;
      for(let c=i;c<n;c++) A[r][c]-=f*A[i][c]; b[r]-=f*b[i]; }
  }
  return b;
}

/* ==================== –ê–í–¢–û–†–ê–°–ß–Å–¢ ==================== */
let recalcTimer=null;
function recalc(){ if(recalcTimer) cancelAnimationFrame(recalcTimer); recalcTimer=requestAnimationFrame(()=>{ redraw(); calcZ(); }); }

/* ==================== –ö–ù–û–ü–ö–ò ==================== */
$('#btnAmp').onclick=()=>addAmp(110,140+Math.random()*120);
$('#btnSpk').onclick=()=>addSpk(520,140+Math.random()*260);
$('#btnCalc').onclick=()=>{ redraw(); calcZ(); };
$('#btnClear').onclick=()=>{ st.amp=null; st.spk.length=0; st.wires.length=0; st.src.pos=null; st.src.neg=null; $$('#stage .node').forEach(n=>n.remove()); svg.innerHTML=''; result.textContent='‚Äî'; refreshList(); logWarn('–°—Ü–µ–Ω–∞ –æ—á–∏—â–µ–Ω–∞'); };

/* ==================== –î–ï–ú–û ==================== */
(function demo(){
  addAmp(110,180);
  addSpk(520,140);
  addSpk(520,240);
  st.wires.push({a:st.amp.plus,b:st.spk[0].plus,id:nextId('w_')});
  st.wires.push({a:st.amp.plus,b:st.spk[1].plus,id:nextId('w_')});
  st.wires.push({a:st.spk[0].minus,b:st.spk[1].minus,id:nextId('w_')});
  st.wires.push({a:st.amp.minus,b:st.spk[0].minus,id:nextId('w_')});
  recalc();
  logInfo('–î–µ–º–æ: 2√ó8Œ© –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (~4Œ©)');
})();
</script>
</body>
</html>
